/* --------------------------------------------------------------------------------
  This file was automatically generated by the Athlos Project Editor.
  Athlos Project Editor, v1.0 BETA
-------------------------------------------------------------------------------- */

package com.example.marspioneer.service;
import com.example.marspioneer.model.MPPlayer;
import com.example.marspioneer.model.MPTeam;
import com.example.marspioneer.model.MPWorld;
import com.example.marspioneer.persistence.DBManager;
import com.example.marspioneer.proto.UpdateTeamResponse;
import com.nkasenides.athlos.backend.AthlosService;
import com.example.marspioneer.proto.UpdateWorldRequest;
import com.example.marspioneer.auth.*;
import com.example.marspioneer.proto.UpdateWorldResponse;

public class UpdateWorld implements AthlosService<UpdateWorldRequest, UpdateWorldResponse> {

    @Override    
    public UpdateWorldResponse serve(UpdateWorldRequest request, Object... additionalParams) {
        //Verify game session:
        final MPPlayer callingPlayer = Auth.verifyGameSessionID(request.getGameSessionID());
        if (callingPlayer == null) {
            return UpdateWorldResponse.newBuilder()
                    .setStatus(UpdateWorldResponse.Status.NOT_AUTHORIZED)
                    .setMessage("NOT_AUTHORIZED")
                    .build();
        }

        final MPWorld world = DBManager.world.get(request.getWorld().getId());
        if (world == null) {
            return UpdateWorldResponse.newBuilder()
                    .setStatus(UpdateWorldResponse.Status.NO_SUCH_WORLD)
                    .setMessage("NO_SUCH_WORLD")
                    .build();
        }

        if (!callingPlayer.getId().equals(world.getOwnerID())) {
            return UpdateWorldResponse.newBuilder()
                    .setStatus(UpdateWorldResponse.Status.NOT_AUTHORIZED)
                    .setMessage("NOT_AN_OWNER")
                    .build();
        }

        DBManager.world.update(request.getWorld().toObject());

        return UpdateWorldResponse.newBuilder()
                .setStatus(UpdateWorldResponse.Status.OK)
                .setMessage("OK")
                .build();
    }    
    
}

